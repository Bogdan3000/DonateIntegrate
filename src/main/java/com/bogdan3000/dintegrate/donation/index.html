<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrifuge DonatePay Connection</title>
</head>
<body>
<h1>Подключение к Centrifugo через DonatePay</h1>
<p>Открой консоль (F12 → Console), чтобы увидеть входящие сообщения.</p>

<!-- Импорт centrifuge-js -->
<script src="https://cdn.jsdelivr.net/gh/centrifugal/centrifuge-js@2.X.X/dist/centrifuge.min.js"></script>

<script>
    async function start() {
        // Создание экземпляра Centrifuge
        window.centrifuge = new Centrifuge('wss://centrifugo.donatepay.ru:443/connection/websocket', {
            subscribeEndpoint: 'https://donatepay.ru/api/v2/socket/token',
            subscribeParams: {
                access_token: 'cNczbdJnLGrJEJLburoudonCHQzWAjj9i01L9J7uc3ZhQoJAGNfMegNjHogU'
            },
            disableWithCredentials: true
        });

        // Получение токена
        centrifuge.setToken(await getToken());

        // Подписка на канал пользователя
        centrifuge.subscribe("$public:1377866", function (message) {
            console.log('message', message);
        });

        centrifuge.on('error', (e) => {
            console.error('error', e);
        });

        centrifuge.on('subscribe', (e) => {
            console.log('subscribe', e);
        });

        centrifuge.on('connect', (e) => {
            console.log('connect', e);
        });

        // Подключение к серверу
        centrifuge.connect();
    }

    // Запрос токена для подключения
    async function getToken() {
        const res = await fetch('https://donatepay.ru/api/v2/socket/token', {
            method: 'POST',
            body: JSON.stringify({
                access_token: 'cNczbdJnLGrJEJLburoudonCHQzWAjj9i01L9J7uc3ZhQoJAGNfMegNjHogU'
            }),
            headers: {
                "Content-Type": "application/json"
            }
        });

        const data = await res.json();
        return data.token;
    }

    // Запуск
    start();
</script>
</body>
</html>